{"version":3,"file":"direct-upload-controller.js","sourceRoot":"","sources":["../../../src/components/uploaded-file/direct-upload-controller.tsx"],"names":[],"mappings":"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","sourcesContent":["import { DirectUpload } from \"@rails/activestorage\"\nimport { UploadedFile } from \"./uploaded-file\"\n\nexport default class DirectUploadController {\n  uploadedFile: UploadedFile\n  file: File\n  directUpload: any\n  recordXHR: XMLHttpRequest\n  uploadXHR: XMLHttpRequest\n  callback = null\n\n  constructor(uploadedFile) {\n    this.uploadedFile = uploadedFile\n    this.file = this.uploadedFile[\"file\"]\n    this.directUpload = new DirectUpload(this.file, this.uploadedFile.url, this)\n  }\n\n  cancel() {\n    this.directUpload.url = null\n    this.abortXHR(this.recordXHR)\n    this.abortXHR(this.uploadXHR)\n  }\n\n  abortXHR(xhr) {\n    if(!xhr) return\n    xhr.addEventListener(\"abort\", () => {\n      this.complete(\"aborted\", {})\n    })\n    xhr.abort()\n  }\n\n  start(callback) {\n    this.callback = callback\n    this.dispatch(\"start\")\n    this.directUpload.create((error, attributes) => {\n      this.complete(error, attributes)\n    })\n  }\n\n  complete(error, _attributes) {\n    if (error) {\n      this.dispatchError(error)\n    }\n    this.dispatch(\"end\")\n    this.callback(error)\n  }\n\n  uploadRequestDidProgress(event) {\n    const progress = event.loaded / event.total * 100;\n    if (progress) {\n      this.dispatch(\"progress\", {\n        progress: progress\n      });\n    }\n  }\n  dispatch(name, detail = {}) {\n    return dispatchEvent(this.uploadedFile, `direct-upload:${name}`, {\n      detail: {\n        ...detail,\n        file: this.file,\n        id: this.directUpload.id,\n      }\n    });\n  }\n  dispatchError(error) {\n    this.dispatch(\"error\", {\n      error: error\n    })\n  }\n  directUploadWillCreateBlobWithXHR(xhr) {\n    this.recordXHR = xhr\n    this.dispatch(\"before-blob-request\", {\n      xhr: xhr\n    });\n  }\n  directUploadWillStoreFileWithXHR(xhr) {\n    this.uploadXHR = xhr\n    this.uploadedFile.value = this.recordXHR.response.signed_id\n    this.dispatch(\"before-storage-request\", {\n      xhr: xhr\n    });\n    xhr.upload.addEventListener(\"progress\", (event => this.uploadRequestDidProgress(event)));\n  }\n}\n\nfunction dispatchEvent(element: any, type, eventInit = {} as any) {\n  const {disabled: disabled} = element;\n  const {bubbles: bubbles, cancelable: cancelable, detail: detail} = eventInit;\n  const event = document.createEvent(\"Event\") as any;\n  event.initEvent(type, bubbles || true, cancelable || true);\n  event.detail = detail || {};\n  try {\n    element.disabled = false;\n    element.dispatchEvent(event);\n  } finally {\n    element.disabled = disabled;\n  }\n  return event;\n}\n\n"]}