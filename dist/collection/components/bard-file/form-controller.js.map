{"version":3,"file":"form-controller.js","sourceRoot":"","sources":["../../../src/components/bard-file/form-controller.tsx"],"names":[],"mappings":"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","sourcesContent":["import DirectUploadController from \"../uploaded-file/direct-upload-controller\"\n\nexport default class FormController {\n  static instance(form) {\n    return form.bardFileFormController ||= new FormController(form)\n  }\n\n  progressContainerTarget: HTMLElement\n  dialog: HTMLDialogElement\n\n  element: HTMLFormElement\n  progressTargetMap: {}\n  controllers: Array<DirectUploadController>\n  submitted: boolean\n  processing: boolean\n  errors: boolean\n\n  constructor(form) {\n    this.element = form\n    this.progressTargetMap = {}\n    this.controllers = []\n    this.submitted = false\n    this.processing = false\n    this.errors = false\n\n    this.element.insertAdjacentHTML(\"beforeend\",\n      `<dialog id=\"form-controller-dialog\">\n        <div class=\"direct-upload-wrapper\">\n          <div class=\"direct-upload-content\">\n            <h3>Uploading your media</h3>\n            <div id=\"progress-container\"></div>\n          </div>\n        </div>\n      </dialog>`)\n\n    this.dialog = this.element.querySelector(\"#form-controller-dialog\")\n    this.progressContainerTarget = this.dialog.querySelector(\"#progress-container\")\n\n    if(this.element.dataset.remote !== \"true\" && (this.element.dataset.turbo == \"false\" || !(window as any).Turbo?.session?.enabled)) {\n      this.element.addEventListener(\"submit\", event => this.submit(event))\n    }\n    window.addEventListener(\"beforeunload\", event => this.beforeUnload(event))\n\n    this.element.addEventListener(\"direct-upload:initialize\", event => this.init(event))\n    this.element.addEventListener(\"direct-upload:start\", event => this.start(event))\n    this.element.addEventListener(\"direct-upload:progress\", event => this.progress(event))\n    this.element.addEventListener(\"direct-upload:error\", event => this.error(event))\n    this.element.addEventListener(\"direct-upload:end\", event => this.end(event))\n\n    this.element.addEventListener(\"uploaded-file:remove\", event => this.removeUploadedFile(event))\n  }\n\n  beforeUnload(event) {\n    if(this.processing) {\n      event.preventDefault()\n      return (event.returnValue = \"\")\n    }\n  }\n\n  submit(event) {\n    event.preventDefault()\n    this.submitted = true\n    this.startNextController()\n    if(this.processing) {\n      this.dialog.showModal()\n    }\n  }\n\n  startNextController() {\n    if(this.processing) return\n\n    const controller = this.controllers.shift()\n    if(controller) {\n      this.processing = true\n      controller.start(error => {\n        if(error) {\n          Array.from(this.element.querySelectorAll(\"input[type=file]\"))\n            .forEach((e: HTMLInputElement) => e.disabled = false)\n        }\n        this.processing = false\n        this.startNextController()\n      })\n    } else {\n      this.submitForm()\n    }\n  }\n\n  submitForm() {\n    if(this.submitted) {\n      Array.from(this.element.querySelectorAll(\"input[type=file]\"))\n        .forEach((e: HTMLInputElement) => e.disabled = true)\n      window.setTimeout(() => { // allow other async tasks to complete\n        this.element.submit()\n      }, 10)\n    }\n  }\n\n  init(event) {\n    const { id, file, controller } = event.detail\n\n    this.progressContainerTarget.insertAdjacentHTML(\"beforebegin\", `\n      <progress-bar id=\"direct-upload-${id}\" class=\"direct-upload--pending\">${file.name}</progress-bar>\n    `)\n    const progressTarget = document.getElementById(`direct-upload-${id}`)\n    this.progressTargetMap[id] = progressTarget\n\n    this.controllers.push(controller)\n    this.startNextController()\n  }\n\n  start(event) {\n    this.progressTargetMap[event.detail.id].classList.remove(\"direct-upload--pending\")\n  }\n\n  progress(event) {\n    const { id, progress } = event.detail\n    this.progressTargetMap[id].percent = progress\n  }\n\n  error(event) {\n    event.preventDefault()\n    const { id, error } = event.detail\n    const target = this.progressTargetMap[id]\n    target.classList.add(\"direct-upload--error\")\n    target.title = error\n  }\n\n  end(event) {\n    this.progressTargetMap[event.detail.id].classList.add(\"direct-upload--complete\")\n  }\n\n  removeUploadedFile(event) {\n    const uploadedFile = event.detail\n    const id = uploadedFile.controller?.directUpload?.id\n    if(id) {\n      document.getElementById(`direct-upload-${id}`).remove()\n      delete this.progressTargetMap[id]\n    }\n  }\n}\n\n\n"]}